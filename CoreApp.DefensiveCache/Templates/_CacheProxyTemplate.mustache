using System;
using System.Collections.Generic;
using System.Threading.Tasks;
using Microsoft.Extensions.Caching.Distributed;
using CoreApp.DefensiveCache;
using CoreApp.DefensiveCache.Extensions;
using CoreApp.DefensiveCache.Formatters;

namespace DynamicAssembly
{
    public class {{Name}} : {{InterfaceName}}
    {
        private {{InterfaceName}} _repository;
        private ICacheFormatter _cacheFormatter;
        public {{Name}}({{InterfaceName}} repository, ICacheFormatter cacheFormatter)
        {
            _repository = repository;
            _cacheFormatter = cacheFormatter;
        }

{{#Methods}}
{{#Enabled}}
{{#Async}}
        public async {{ReturnType}} {{Name}}({{ParametersDeclarations}})
        {
            var cacheKey = $"{{{CacheKeyTemplate}}}";
            var cacheValue = await _cacheFormatter.GetAsync<{{ReturnTypeBase}}>(cacheKey);
            if (Equals(cacheValue, default({{ReturnTypeBase}})))
            {
                cacheValue = await _repository.{{Name}}({{ParametersNames}});
                _cacheFormatter.SetAsync(cacheKey, cacheValue, {{CacheExpirationSeconds}});
            }
            return cacheValue;
        }
{{/Async}}
{{^Async}}
        public {{ReturnType}} {{Name}}({{ParametersDeclarations}})
        {
            var cacheKey = $"{{{CacheKeyTemplate}}}";
            var cacheValue = _cacheFormatter.Get<{{ReturnType}}>(cacheKey);
            if (Equals(cacheValue, default({{ReturnType}})))
            {
                cacheValue = _repository.{{Name}}({{ParametersNames}});
                _cacheFormatter.Set(cacheKey, cacheValue, {{CacheExpirationSeconds}});
            }
            return cacheValue;
        }
{{/Async}}
{{/Enabled}}
{{^Enabled}}
        public {{ReturnType}} {{Name}}({{ParametersDeclarations}})
        {
            return _repository.{{Name}}({{ParametersNames}});
        }
{{/Enabled}}
{{^ReturnValue}}
        public void {{Name}}({{ParametersDeclarations}})
        {
            _repository.{{Name}}({{ParametersNames}});
        }
{{/ReturnValue}}
{{/Methods}}
    }
}
